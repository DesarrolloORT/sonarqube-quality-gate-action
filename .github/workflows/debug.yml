name: Debug SonarQube Quality Gate

on:
  workflow_dispatch:
    inputs:
      sonar-host-url:
        description: 'SonarQube server URL'
        required: true
        default: 'https://your-sonar-server.com'
      sonar-project-key:
        description: 'SonarQube project key'
        required: true
      branch:
        description: 'Branch name (optional, usado si no hay PR)'
        required: false
      pr-number:
        description: 'Pull Request number (opcional, tiene prioridad sobre branch)'
        required: false

jobs:
  debug-quality-gate:
    name: Debug Quality Gate
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: ${{ github.event.inputs.sonar-host-url }}
      SONAR_PROJECT_KEY: ${{ github.event.inputs.sonar-project-key }}
      PR_NUMBER: ${{ github.event.inputs['pr-number'] || '' }}
      BRANCH_NAME: ${{ github.event.inputs.branch || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test SonarQube Quality Gate Action (with debug)
        id: quality-gate
        uses: ./
        with:
          sonar-host-url: ${{ env.SONAR_HOST_URL }}
          sonar-project-key: ${{ env.SONAR_PROJECT_KEY }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # si tu acción interna soporta 'branch' o 'pullRequest', podrías pasarle ambos:
          branch: ${{ env.BRANCH_NAME }}
          pullRequest: ${{ env.PR_NUMBER }}
          disable-pr-comment: 'true'
          fail-on-quality-gate-error: 'false'

      - name: Print Results
        run: |
          echo "Project Status: ${{ steps.quality-gate.outputs['project-status'] }}"
          echo "Quality Gate Result: ${{ steps.quality-gate.outputs['quality-gate-result'] }}"

      - name: Test API Manually (Debug)
        run: |
          echo "Testing API manually..."
          echo "Host: $SONAR_HOST_URL"
          echo "Project: $SONAR_PROJECT_KEY"
          echo "PR_NUMBER: ${PR_NUMBER:-<none>}"
          echo "BRANCH_NAME: ${BRANCH_NAME:-<none>}"

          BASE_URL="$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=$SONAR_PROJECT_KEY"
          if [ -n "$PR_NUMBER" ]; then
            BASE_URL="$BASE_URL&pullRequest=$PR_NUMBER"
          elif [ -n "$BRANCH_NAME" ]; then
            BASE_URL="$BASE_URL&branch=$BRANCH_NAME"
          fi
          echo "Resolved URL: $BASE_URL"

          echo "Testing with Bearer token..."
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
            "$BASE_URL")

          HTTP_STATUS=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          BODY=$(echo "$RESPONSE" | sed -e 's/HTTPSTATUS\:.*//g')

          echo "Bearer token response status: $HTTP_STATUS"
          echo "Bearer token response body: $BODY"

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Testing with Basic auth..."
            RESPONSE2=$(curl -s -w "HTTPSTATUS:%{http_code}" \
              -u "${{ secrets.SONAR_TOKEN }}:" \
              "$BASE_URL")

            HTTP_STATUS2=$(echo "$RESPONSE2" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            BODY2=$(echo "$RESPONSE2" | sed -e 's/HTTPSTATUS\:.*//g')

            echo "Basic auth response status: $HTTP_STATUS2"
            echo "Basic auth response body: $BODY2"
          fi