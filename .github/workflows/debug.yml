name: Debug SonarQube Quality Gate

on:
  workflow_dispatch:
    inputs:
      sonar-host-url:
        description: 'SonarQube server URL'
        required: true
        default: 'https://your-sonar-server.com'
      sonar-project-key:
        description: 'SonarQube project key'
        required: true
      branch:
        description: 'Branch name (optional)'
        required: false
  pull_request:
    branches:
      - main
      - master
      - develop
  push:
    branches-ignore:
      - main
      - master

jobs:
  debug-quality-gate:
    name: Debug Quality Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test SonarQube Quality Gate Action (with debug)
        id: quality-gate
        uses: ./
        with:
          sonar-host-url: ${{ github.event.inputs.sonar-host-url}}
          sonar-project-key: ${{ github.event.inputs.sonar-project-key }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.event.inputs.branch }}
          pull-request: ${{ github.event.pull_request.number }}
          disable-pr-comment: 'false' # Enable PR comments
          fail-on-quality-gate-error: 'false' # Don't fail the workflow for debugging

      - name: Print Results
        run: |
          echo "Project Status: ${{ steps.quality-gate.outputs.project-status }}"
          echo "Quality Gate Result: ${{ steps.quality-gate.outputs.quality-gate-result }}"

      - name: Test API Manually (Debug)
        run: |
          echo "Testing API manually..."
          echo "Host: ${{ github.event.inputs.sonar-host-url }}"
          echo "Project: ${{ github.event.inputs.sonar-project-key }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.event.inputs.branch || github.head_ref }}"

          # Build API URL with PR or branch parameter
          BASE_URL="${{ github.event.inputs.sonar-host-url }}/api/qualitygates/project_status?projectKey=${{ github.event.inputs.sonar-project-key }}"

          if [ -n "${{ github.event.pull_request.number }}" ]; then
            API_URL="${BASE_URL}&pullRequest=${{ github.event.pull_request.number }}"
            echo "Using Pull Request parameter"
          elif [ -n "${{ github.event.inputs.branch || github.head_ref }}" ]; then
            API_URL="${BASE_URL}&branch=${{ github.event.inputs.branch || github.head_ref }}"
            echo "Using Branch parameter"
          else
            API_URL="${BASE_URL}"
            echo "Using default (main branch)"
          fi

          echo "API URL: ${API_URL}"

          # Test with Bearer token
          echo "Testing with Bearer token..."
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
            "${API_URL}")

          HTTP_STATUS=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS\:.*//g')

          echo "Bearer token response status: $HTTP_STATUS"
          echo "Bearer token response body: $BODY"

          # Test with Basic auth if Bearer fails
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Testing with Basic auth..."
            RESPONSE2=$(curl -s -w "HTTPSTATUS:%{http_code}" \
              -u "${{ secrets.SONAR_TOKEN }}:" \
              "${API_URL}")

            HTTP_STATUS2=$(echo $RESPONSE2 | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            BODY2=$(echo $RESPONSE2 | sed -e 's/HTTPSTATUS\:.*//g')

            echo "Basic auth response status: $HTTP_STATUS2"
            echo "Basic auth response body: $BODY2"
          fi
